databaseChangeLog:
  - changeSet:
      id: 0012-export-notification-function
      author: system
      changes:
        - sql:
            sql: |
              -- =============================================
              -- EXPORT NOTIFICATION FUNCTION
              -- =============================================
              
              -- Create or replace the notify_export_ready function
              CREATE OR REPLACE FUNCTION notify_export_ready(export_id uuid, glb_url text)
              RETURNS void
              LANGUAGE plpgsql
              SECURITY DEFINER
              AS 'BEGIN
                PERFORM pg_notify(''export_channel'', json_build_object(
                  ''exportId'', export_id, 
                  ''glbUrl'', glb_url,
                  ''timestamp'', extract(epoch from now())
                )::text);
                
                PERFORM pg_notify(''exports'', json_build_object(
                  ''type'', ''export_ready'',
                  ''exportId'', export_id,
                  ''glbUrl'', glb_url,
                  ''timestamp'', extract(epoch from now())
                )::text);
              END;';
              
              -- Grant execute permissions to service_role
              GRANT EXECUTE ON FUNCTION notify_export_ready(uuid, text) TO service_role;
              
              -- Grant execute permissions to authenticated users
              GRANT EXECUTE ON FUNCTION notify_export_ready(uuid, text) TO authenticated;
