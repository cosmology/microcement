databaseChangeLog:
  - changeSet:
      id: fix-storage-service-role-permissions
      author: microcement-dev
      changes:
        - sql:
            comment: Grant service_role permissions for storage operations and disable RLS
            splitStatements: false
            sql: |
              -- Disable RLS on storage tables (dev environment)
              ALTER TABLE storage.buckets DISABLE ROW LEVEL SECURITY;
              ALTER TABLE storage.objects DISABLE ROW LEVEL SECURITY;
              
              -- Grant service_role full access to storage schema
              GRANT ALL ON SCHEMA storage TO service_role;
              GRANT ALL ON ALL TABLES IN SCHEMA storage TO service_role;
              GRANT ALL ON ALL SEQUENCES IN SCHEMA storage TO service_role;
              
              -- Grant execute permissions on set_config (required by storage API)
              GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO service_role;
              GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO anon;
              GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO authenticated;
              
              -- Create service role bypass policy (belt and suspenders)
              DROP POLICY IF EXISTS "service_role_bypass_all" ON storage.objects;
              CREATE POLICY "service_role_bypass_all"
              ON storage.objects
              FOR ALL
              TO service_role
              USING (true)
              WITH CHECK (true);
              
              -- Ensure bucket exists
              INSERT INTO storage.buckets (id, name, public)
              VALUES ('app-uploads', 'app-uploads', false)
              ON CONFLICT (id) DO UPDATE SET public = false;

